# 自动化构建

## Grunt

### 安装grunt：`yarn add grunt` ，编写gruntfile.js文件：

```javascript
// Grunt的入口文件
// 用于定义一些需要Grunt自动执行的任务
// 需要导出一个函数
// 此函数接受一个grunt的形参，内部提供一些创建任务时可以用到的API

module.exports = grunt => {
  grunt.registerTask('foo', () => {
    console.log('hello grunt ~')
  })

  grunt.registerTask('bar', '任务描述', () => {
    console.log('other task~')
  })

  grunt.registerTask('default', () => {
    console.log('default task')
  })

  grunt.registerTask('default', ['foo', 'bad', 'bar'])

  // grunt.registerTask('async-task', () => {
  //   setTimeout(() => {
  //     console.log('async task working')
  //   }, 1000);
  // })

  // 异步任务，done()表示结束
  grunt.registerTask('async-task', function () {
    const done = this.async()
    setTimeout(() => {
      console.log('async task working..')
      done()
    }, 1000);
  })

  // 失败任务
  grunt.registerTask('bad', () => {
    console.log('bad working...')
    return false
  })

  // 异步失败任务，done(false)表示结束
  grunt.registerTask('bad-async-task', function () {
    const done = this.async()
    setTimeout(() => {
      console.log('bad async task working..')
      done(false)
    }, 1000);
  })
}
```

执行构建任务： `yarn grunt`

### 配置选项

```javascript
  module.exports = grunt => {
  
    grunt.initConfig({
      foo: {
        bar: 123
      }
    })
  
    grunt.registerTask('foo', () => {
      console.log(grunt.config('foo.bar')) // 123
    })
  }
```

### 多目标任务

```javascript
  module.exports = grunt => {
  
    grunt.initConfig({
      build: {
        options: { // 是配置选项，不会作为任务
          foo: 'bar'
        },
        css: {
          options: { // 会覆盖上层的options
            foo: 'baz'
          }
        },
        js: '2'
      }
    })
    
    // 多目标任务，可以让任务根据配置形成多个子任务
    grunt.registerMultiTask('build', function () {
      console.log(this.options())
      console.log(`build task: ${this.target}, data: ${this.data}`)
    })
  }
```

执行命令：`yarn grunt build`, 输出结果：

```shell
    Running "build:css" (build) task
    { foo: 'baz' }
    build task: css, data: [object Object]

    Running "build:js" (build) task
    { foo: 'bar' }
    build task: js, data: 2
```

### grunt插件使用

使用clean插件： `yarn add grunt-contrib-clean`

```javascript
  module.exports = grunt => {
  
    grunt.initConfig({
      clean: {
        temp: 'temp/**' // ** 表示temp下的子目录以及子目录下的文件
      }
    })
  
    grunt.loadNpmTasks('grunt-contrib-clean')
  }
  ```

  执行：`yarn grunt clean` ，就会删除temp文件夹

**常用插件总结：**

* grunt-sass
* grunt-babel
* grunt-watch

```javascript
  const sass = require('sass')
  const loadGruntTasks = require('load-grunt-tasks')
  module.exports = grunt => {
    grunt.initConfig({
      sass: {
        options: {
          sourceMap: true,
          implementation: sass
        },
        main: {
          files: {
            'dist/css/main.css': 'src/scss/main.scss'
          }
        }
      },
      babel: {
        options: {
          presets: ['@babel/preset-env'],
          sourceMap: true
        },
        main: {
          files: {
            'dist/js/app.js': 'src/js/app.js'
          }
        }
      },
      watch: {
        js: {
          files: ['src/js/*.js'],
          tasks: ['babel']
        },
        css: {
          files: ['src/scss/*.scss'],
          tasks: ['sass']
        }
      }
    })
  
    // grunt.loadNpmTasks('grunt-sass')
    loadGruntTasks(grunt) // 自动加载所有的grunt插件中的任务
  
    grunt.registerTask('default', ['sass', 'babel', 'watch'])
  }
```



## Gulp

### gulp的使用

安装gulp：yarn add gulp

gulpfile.js:

```javascript
// gulp的入口文件
exports.foo = done => {
  console.log('foo task working...')

  done() // 标识任务完成
}

exports.default = done => {
  console.log('default task working...')
  done()
}
```

执行命令：yarn gulp foo

### 串行、并行

```javascript
  const {series, parallel} = require('gulp')
  
  // gulp的入口文件
  exports.foo = done => {
    console.log('foo task working...')
  
    done() // 标识任务完成
  }
  
  exports.default = done => {
    console.log('default task working...')
    done()
  }
  
  const task1 = done => {
    setTimeout(() => {
      console.log('task1 working...')
      done()
    }, 1000);
  }
  
  const task2 = done => {
    setTimeout(() => {
      console.log('task2 working...')
      done()
    }, 1000);
  }
  
  const task3 = done => {
    setTimeout(() => {
      console.log('task3 working...')
      done()
    }, 1000);
  }
  
  // series 串行执行
  // exports.bar = series(task1, task2, task3)
  
  // parallel 并行执行
  exports.bar = parallel(task1, task2, task3)
```

### Gulp的异步任务：

```javascript
  const fs = require('fs')
  
  exports.callback = done => {
    console.log('callback task...')
    done()
  }
  
  exports.callback_error = done => {
    console.log('callback task...')
    done(new Error('task failed!'))
  }
  
  exports.promise = () => {
    console.log('promise task...')
    return Promise.resolve()
  }
  
  exports.promise_error = () => {
    console.log('promise task...')
    return Promise.reject(new Error('task failed'))
  }
  
  const timeout = time => {
    return new Promise(resolve => {
      setTimeout(resolve, time);
    })
  }
  exports.async = async() => {
    await timeout(1000)
    console.log('async task...')
  }
  
  exports.stream = (done) => {
    const readStream = fs.createReadStream('package.json')
    const writeSteam = fs.createWriteStream('temp.txt')
    readStream.pipe(writeSteam)
    // return readStream
    readStream.on('end', () => {
      done()
    })
  }
```

### Gulp构建过程，例子：压缩CSS

```javascript
  const fs = require('fs')
  const {Transform} = require('stream')
  
  exports.default = () => {
    const read = fs.createReadStream('normalize.css')
    const write = fs.createWriteStream('normalize.min.css')
    // 文件转化流
    const transform = new Transform({
      transform: (chunk, encoding, callback) => {
        // 核心转化过程
        // chunk => 读取流中读取的内容(Buffer )
        const input = chunk.toString()
        // 转化空白符和注释
        const output = input.replace(/\s+/g, '').replace(/\/\*.+?\*\//g, '')
        callback(null, output)
      }
    })
  
    read
    .pipe(transform) // 先转化
    .pipe(write)
  
    return read
  }
```

### Gulp文件api

```javascript
  const {src, dest} = require('gulp')
  const cleanCss = require('gulp-clean-css')
  const rename = require('gulp-rename')
  
  exports.default = () => {
    return src('src/*.css')
    .pipe(cleanCss())
    .pipe(rename({ extname: '.min.css' }))
    .pipe(dest('dist'))
  }
```

### Gulp构建

```javascript
  const {src, dest, parallel, series, watch} = require('gulp')
  
  const del = require('del')
  const browserSync = require('browser-sync')
  
  const bs = browserSync.create()
  
  const loadPlugins = require('gulp-load-plugins')
  const plugins = loadPlugins()
  // 后面的插件都是plugins的属性，如：plugins.sass
  
  
  const {sass, babel, swig, imagemin} = plugins
  
  // const sass = require('gulp-sass')
  // const babel = require('gulp-babel')
  // const swig = require('gulp-swig')
  // const imagemin = require('gulp-imagemin')
  const data = {
    menus: [
      {
        name: 'Home',
        icon: 'aperture',
        link: 'index.html'
      },
      {
        name: 'Features',
        link: 'features.html'
      },
      {
        name: 'About',
        link: 'about.html'
      },
      {
        name: 'Contact',
        link: '#',
        children: [
          {
            name: 'Twitter',
            link: 'https://twitter.com/w_zce'
          },
          {
            name: 'About',
            link: 'https://weibo.com/zceme'
          },
          {
            name: 'divider'
          },
          {
            name: 'About',
            link: 'https://github.com/zce'
          }
        ]
      }
    ],
    pkg: require('./package.json'),
    date: new Date()
  }
  
  const clean = () => {
    return del(['dist', 'temp'])
  }
  
  const style = () => {
    return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(sass({ outputStyle: 'expanded' }))
    .pipe(dest('temp'))
    .pipe(bs.reload({stream: true}))
  }
  
  const script = () => {
    return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('temp'))
    .pipe(bs.reload({stream: true}))
  }
  
  const page = () => {
    return src('src/**/*.html', {base: 'src'})
    .pipe(swig(data))
    .pipe(dest('temp'))
    .pipe(bs.reload({stream: true}))
  }
  
  const image = () => {
    return src('src/assets/images/**', {base: 'src'})
    .pipe(imagemin())
    .pipe(dest('dist'))
  }
  
  const font = () => {
    return src('src/assets/fonts/**', {base: 'src'})
    .pipe(imagemin())
    .pipe(dest('dist'))
  }
  
  const extra = () => {
    return src('public/**', {base: 'public'})
    .pipe(dest('dist'))
  }
  
  const serve = () => {
    watch('src/assets/styles/*.scss', style)
    watch('src/assets/scripts/*.js', script)
    watch('src/*.html', page)
    // watch('src/assets/images/**', image)
    // watch('src/assets/fonts/**', font)
    // watch('public/**', extra)
  
    watch([
      'src/assets/images/**'，
      'src/assets/fonts/**',
      'public/**'
    ], bs.reload)
  
    bs.init({
      notify: false,
      port: 2080,
      open: false,
      // files: 'temp/**',
      server: {
        baseDir: ['temp', 'src', 'public'], // 按顺序查找
        routes: {
          '/node_modules': 'node_modules'
        }
      }
    })
  }
  
  const useref = () => {
    return src('temp/*.html', { base: 'temp' })
    .pipe(plugins.useref({ searchPath: ['temp', '.'] }))
    .pipe(plugins.if(/\.js$/, plugins.uglify()))
    .pipe(plugins.if(/\.css$/, plugins.cleanCss()))
    .pipe(plugins.if(/\.html$/, plugins.htmlmin({
      collapseWhitespace: true,
      minifyCSS: true,
      minifyJS: true
    })))
    .pipe(dest('dist'))
  }
  
  // const compile = parallel(style, script, page, image, font)
  const compile = parallel(style, script, page)
  
  // 上线之前执行的任务
  const build = series(
    clean,
    parallel(
      serise(compile, useref)
      image,
      font,
      extra
    )
  )
  
  // 开发阶段
  const develop = series(compile, serve)
  
  module.exports = {
    compile,
    build,
    develop,
  }
```

### Gulp补充

## FIS
